<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gestión Académica - ESCOM</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCZeMVzktIZrSRy0eO10nov8jCbUccCRwQ",
      authDomain: "protocoloeticaescom.firebaseapp.com",
      projectId: "protocoloeticaescom",
      storageBucket: "protocoloeticaescom.firebasestorage.app",
      messagingSenderId: "517297941072",
      appId: "1:517297941072:web:ee58c6d304848045b5ff55",
      databaseURL: "https://protocoloeticaescom-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <style>
    :root { --vino: #6d1d38; --azul: #008fcc; --verde: #28a745; --fondo: #f4f4f4; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: url("fondo.jpg") no-repeat center center fixed; background-size: cover; color: #333; }
    #login-screen, #survey-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: rgba(0,0,0,0.85); position: fixed; width: 100%; z-index: 2000; }
    .card-ui { background: white; padding: 35px; border-radius: 20px; width: 400px; text-align: center; }
    header { background: var(--vino); color: white; padding: 15px 40px; display: flex; align-items: center; justify-content: space-between; }
    main { display: grid; grid-template-columns: 350px 1fr; gap: 25px; max-width: 1400px; margin: 25px auto; padding: 0 20px; }
    .card-custom { background: rgba(255, 255, 255, 0.98); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .progress-container { background: #eee; border-radius: 12px; height: 35px; overflow: hidden; margin: 15px 0; }
    .progress-fill { background: var(--azul); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: width 1s; }
    .task-item-box { background: white; border-radius: 15px; padding: 18px; display: flex; justify-content: space-between; align-items: center; border-left: 10px solid var(--azul); margin-top: 15px; }
    .btn-concluir { background: var(--verde); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; }
    #admin-dashboard { display: none; background: #f0f2f5; min-height: 100vh; }
    .admin-content { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .log-monitor { background: #000; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 12px; height: 300px; overflow-y: auto; }
    .hidden { display: none !important; }
    input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<div id="login-screen">
  <div class="card-ui">
    <img src="mascota_escom.jpg" width="80" alt="ESCOM">
    <h2 style="color:var(--vino)">Portal de Productividad</h2>
    <input type="text" id="userInput" placeholder="Boleta o Usuario" style="width:90%; margin-bottom:15px;">
    <input type="password" id="passInput" placeholder="Contraseña" style="width:90%; margin-bottom:20px;">
    <button onclick="handleLogin()" style="width:100%; background:var(--vino); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer;">INGRESAR</button>
    <p id="error-msg" style="color:red;"></p>
  </div>
</div>

<div id="survey-screen" class="hidden">
  <div class="card-ui" style="width:500px">
    <h3>Evaluación Pre-Prueba (ISO 9241)</h3>
    <p>¿Qué tan fragmentada sientes tu información hoy? (1-5)</p>
    <input type="range" id="q1" min="1" max="5" style="width:100%">
    <button onclick="accessStudentDashboard()" style="margin-top:25px; width:100%; background:var(--vino); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer;">Comenzar Sesión</button>
  </div>
</div>

<div id="main-dashboard" class="hidden">
  <header>
    <div><img src="mascota_escom.jpg" height="40"> <strong><span id="sName"></span></strong></div>
    <button onclick="location.reload()" style="background:none; color:white; border:1px solid white; padding:5px; cursor:pointer;">Cerrar Sesión</button>
  </header>
  <main>
    <aside>
      <div class="card-custom">
        <h3>Avance Curricular (ISC 2020)</h3>
        <div class="progress-container"><div id="barWidth" class="progress-fill">0%</div></div>
        <div id="credInfo" style="color:var(--azul);">Créditos: --</div>
      </div>
      <div class="card-custom" style="background:#2c3e50; color:white;">
        <h3>Pomodoro</h3>
        <div style="font-size:2em;" id="pTime">25:00</div>
        <button onclick="togglePomo()" id="pBtn" style="background:#e67e22; border:none; color:white; padding:10px; cursor:pointer;">Iniciar</button>
      </div>
    </aside>
    <section>
      <div class="card-custom">
        <h3>Tareas y Plazos</h3>
        <div style="display:flex; gap:10px;">
          <input type="text" id="tName" placeholder="Nueva tarea..." style="flex:2;">
          <input type="date" id="tDate">
          <button onclick="addTask()" style="background:var(--vino); color:white; border:none; padding:10px; cursor:pointer;">Programar</button>
        </div>
        <div id="taskList"></div>
      </div>
    </section>
  </main>
</div>

<div id="admin-dashboard">
  <header style="background:#333;"><strong>PANEL DE CONTROL (TIEMPO REAL)</strong></header>
  <div class="admin-content">
    <div class="card-custom"><canvas id="productivityChart"></canvas></div>
    <div class="card-custom">
      <h3>Monitor de Actividad</h3>
      <div class="log-monitor" id="adminLogs"></div>
      <button onclick="exportEvidencePDF()" style="width:100%; margin-top:10px; background:var(--azul); color:white; border:none; padding:10px; cursor:pointer;">Exportar PDF</button>
    </div>
  </div>
</div>

<script>
  const ADMIN = { user: "administrador", pass: "admin2026" };
  const alumnosDB = [
    { u: "2026630001", p: "escom2026", n: "Pamela Torres Martinez", av: 45, cr: 157 },
    { u: "2026630009", p: "escom2026", n: "Esmeralda Arizbeth Chagoya Martinez", av: 48, cr: 168 },
    { u: "2026630011", p: "escom2026", n: "Ethan Eliud Ramirez Barajas", av: 46, cr: 161 },
    { u: "2026630013", p: "escom2026", n: "Christopher Emmanuel Aguilera Garcia", av: 42, cr: 147 },
    { u: "2026630024", p: "escom2026", n: "Ismael Alvarado Olasagasti", av: 48, cr: 168 },
    { u: "2026630037", p: "escom2026", n: "Liliana Martinez Acosta", av: 55, cr: 192 }
    /* Nota: He resumido la lista aquí, pero puedes pegar los 37 alumnos que tenías antes */
  ];

  let currentStudent = null;

  function writeLog(accion) {
    if (!currentStudent) return;
    database.ref('logs_alumnos').push({
        alumno: currentStudent.n,
        boleta: currentStudent.u,
        accion: accion,
        fecha: new Date().toLocaleString()
    });
  }

  function handleLogin() {
    const u = document.getElementById('userInput').value;
    const p = document.getElementById('passInput').value;

    if (u === ADMIN.user && p === ADMIN.pass) {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('admin-dashboard').style.display = 'block';
      escucharLogsEnTiempoReal();
      loadAdminChart();
    } else {
      const student = alumnosDB.find(a => a.u === u && a.p === p);
      if (student) {
        currentStudent = student;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('survey-screen').classList.remove('hidden');
        writeLog("Ingreso al sistema");
      } else {
        document.getElementById('error-msg').textContent = "Credenciales incorrectas";
      }
    }
  }

  function accessStudentDashboard() {
    document.getElementById('survey-screen').classList.add('hidden');
    document.getElementById('main-dashboard').classList.remove('hidden');
    document.getElementById('sName').textContent = currentStudent.n;
    document.getElementById('barWidth').style.width = currentStudent.av + "%";
    document.getElementById('barWidth').textContent = currentStudent.av + "%";
    document.getElementById('credInfo').textContent = `Créditos: ${currentStudent.cr} / 350`;
    cargarTareas(currentStudent.u);
  }

  function addTask() {
    const name = document.getElementById('tName').value;
    const date = document.getElementById('tDate').value;
    if(!name) return;
    database.ref('tareas/' + currentStudent.u).push({ nombre: name, fecha: date });
    writeLog(`Agregó tarea: ${name}`);
    document.getElementById('tName').value = "";
  }

  function cargarTareas(boleta) {
    database.ref('tareas/' + boleta).on('value', (snapshot) => {
      const list = document.getElementById('taskList');
      list.innerHTML = "";
      const data = snapshot.val();
      if(data) {
        Object.keys(data).forEach(id => {
          const t = data[id];
          const div = document.createElement('div');
          div.className = 'task-item-box';
          div.innerHTML = `<div><b>${t.nombre}</b><br><small>${t.fecha}</small></div>
                           <button class="btn-concluir" onclick="finalizarTarea('${id}','${t.nombre}')">Concluir</button>`;
          list.prepend(div);
        });
      }
    });
  }

  function finalizarTarea(id, nombre) {
    database.ref(`tareas/${currentStudent.u}/${id}`).remove();
    writeLog(`Finalizó tarea: ${nombre}`);
  }

  function escucharLogsEnTiempoReal() {
    database.ref('logs_alumnos').limitToLast(50).on('value', (snapshot) => {
      const box = document.getElementById('adminLogs');
      box.innerHTML = "";
      const data = snapshot.val();
      if(data) {
        Object.values(data).reverse().forEach(l => {
          box.innerHTML += `<div><small>${l.fecha}</small> <b>${l.alumno}</b>: ${l.accion}</div>`;
        });
      }
    });
  }

  function loadAdminChart() {
    new Chart(document.getElementById('productivityChart'), {
      type: 'bar',
      data: {
        labels: alumnosDB.map(a => a.n.split(' ')[0]),
        datasets: [{ label: '% Avance', data: alumnosDB.map(a => a.av), backgroundColor: '#6d1d38' }]
      }
    });
  }

  function togglePomo() {
    const btn = document.getElementById('pBtn');
    const act = btn.textContent === "Iniciar" ? "Activó Pomodoro" : "Pausó Pomodoro";
    btn.textContent = btn.textContent === "Iniciar" ? "Pausar" : "Iniciar";
    writeLog(act);
  }

  function exportEvidencePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Evidencia Trazabilidad 2CM2", 10, 10);
    database.ref('logs_alumnos').once('value', (s) => {
      let y = 20;
      Object.values(s.val()).forEach(l => {
        doc.text(`${l.fecha} - ${l.alumno}: ${l.accion}`, 10, y);
        y += 7;
      });
      doc.save("Evidencia_ESCOM.pdf");
    });
  }
</script>
</body>
</html>
