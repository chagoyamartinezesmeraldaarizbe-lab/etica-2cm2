<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Productividad ESCOM - Grupo 2CM2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --vino: #6d1d38; --azul: #008fcc; --verde: #28a745; --naranja: #e67e22; --rojo: #dc3545; --negro: #1a1a1a; --gris: #cccccc; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: url("fondo.jpg") no-repeat center center fixed; background-size: cover; }
    
    #login-screen, #survey-screen, #post-survey-screen, #map-modal { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: rgba(0,0,0,0.85); position: fixed; width: 100%; z-index: 2000; }
    .card-ui { background: white; padding: 30px; border-radius: 20px; width: 550px; text-align: center; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }

    header { background: var(--vino); color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    main { display: grid; grid-template-columns: 350px 1fr; gap: 25px; max-width: 1400px; margin: 25px auto; padding: 0 20px; }
    .card-custom { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

    .progress-bar-container { background: #eee; border-radius: 15px; height: 30px; overflow: hidden; margin: 15px 0; border: 1px solid #ddd; }
    .progress-fill { background: var(--azul); height: 100%; width: 0%; transition: width 1.5s ease; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }

    /* Estilos Mapa */
    .map-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; text-align: left; }
    .subject-box { padding: 12px; border: 2px solid var(--gris); border-radius: 10px; cursor: pointer; transition: 0.3s; background: #fff; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; }
    .subject-box.passed { background: var(--verde); color: white; border-color: #1e7e34; }
    .subject-box.locked { opacity: 0.4; cursor: not-allowed; background: #f0f0f0; filter: grayscale(1); }
    .sem-header { grid-column: span 2; font-weight: bold; color: var(--vino); border-bottom: 2px solid var(--vino); margin-top: 10px; }

    /* Estilos Tareas */
    .task-input-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; background: white; padding: 15px; border-radius: 15px; border: 1px solid #ddd; align-items: center; }
    .task-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .task-box { background: white; padding: 15px; border-radius: 12px; border-left: 10px solid var(--azul); display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .urg-3 { border-left-color: var(--rojo) !important; }
    .urg-2 { border-left-color: var(--naranja) !important; }
    .task-box.done { border-left-color: var(--verde) !important; background: #f0fff0; opacity: 0.8; }
    .btn-action-group { display: flex; gap: 5px; margin-top: 10px; justify-content: flex-end; }
    
    .hidden { display: none !important; }
    input, select { padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    .btn-prog { background: var(--vino); color: white; border: none; cursor: pointer; font-weight: bold; padding: 10px 20px; border-radius: 8px; }
    .btn-small { border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; color: white; font-size: 0.75em; font-weight: bold; }
    .log-monitor { background: #000; color: #00ff00; font-family: monospace; padding: 15px; height: 300px; overflow-y: auto; border-radius: 10px; text-align: left; font-size: 0.8em; }
  </style>
</head>
<body>

<div id="login-screen">
  <div class="card-ui" style="width:350px">
    <img src="mascota_escom.jpg" width="90">
    <h2 style="color:var(--vino)">Portal AcadÃ©mico 2CM2</h2>
    <input type="text" id="userInput" placeholder="Boleta / Admin" style="width:90%; margin-bottom:10px;">
    <input type="password" id="passInput" placeholder="ContraseÃ±a" style="width:90%">
    <button onclick="handleLogin()" class="btn-prog" style="width:95%; margin-top:15px">INGRESAR</button>
  </div>
</div>

<div id="map-modal" class="hidden"><div class="card-ui"><h3 style="color:var(--azul)">Mapa Curricular ISC 2020</h3><div class="map-grid" id="mapGrid"></div><button onclick="document.getElementById('map-modal').classList.add('hidden')" class="btn-prog" style="margin-top:20px; background:var(--azul)">Cerrar</button></div></div>

<div id="survey-screen" class="hidden"><div class="card-ui"><h3>Pre-Prueba</h3><div id="pre-qs" style="text-align:left; font-size:0.85em"></div><button onclick="saveSurvey('pre')" class="btn-prog" style="width:100%; margin-top:15px">Entrar al Dashboard</button></div></div>
<div id="post-survey-screen" class="hidden"><div class="card-ui"><h3>Post-Prueba</h3><div id="post-qs" style="text-align:left; font-size:0.85em"></div><button onclick="saveSurvey('post')" class="btn-prog" style="width:100%; margin-top:15px; background:var(--azul)">Finalizar Prueba</button></div></div>

<div id="student-dash" class="hidden">
  <header>
    <div><strong>Portal: <span id="studName"></span></strong></div>
    <div>
        <button onclick="document.getElementById('post-survey-screen').classList.remove('hidden')" style="background:var(--verde); color:white; border:none; padding:8px 15px; border-radius:10px; margin-right:15px; cursor:pointer; font-weight:bold;">Realizar Post-Prueba</button>
        <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:5px; cursor:pointer">Salir</button>
    </div>
  </header>
  <main>
    <aside>
        <div class="card-custom">
            <h4>Avance Curricular</h4>
            <div class="progress-bar-container"><div id="pBar" class="progress-fill">0%</div></div>
            <p id="creditosInfo" style="font-size:0.8em; font-weight:bold; margin-bottom:10px;"></p>
            <button onclick="openMap()" class="btn-prog" style="background:var(--azul)">Ver Materias</button>
        </div>
        <div class="card-custom" style="background:var(--negro); color:white; text-align:center">
            <h4 id="pLabel">TÃ©cnica Pomodoro</h4>
            <div style="font-size:2.8em; font-weight:bold; margin:10px 0;" id="pTime">25:00</div>
            <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                <button onclick="startPomo(25)" style="background:var(--verde); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">Enfoque</button>
                <button onclick="startPomo(5)" style="background:var(--azul); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">Descanso</button>
                <button onclick="pausePomo()" style="background:var(--naranja); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">Pausar</button>
                <button onclick="resetPomo()" style="background:var(--rojo); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">Reset</button>
            </div>
        </div>
    </aside>
    <section>
        <div class="card-custom">
            <h3>Gestor de Tareas y Plazos</h3>
            <div class="task-input-group">
                <input type="text" id="tIn" placeholder="Materia y Tarea..." style="flex:2">
                <input type="date" id="tDate">
                <select id="tUrg"><option value="1">Baja</option><option value="2" selected>Media</option><option value="3">Alta</option></select>
                <button onclick="addTask()" class="btn-prog">Programar</button>
            </div>
            <h4 id="notif-text" style="color:var(--naranja); display:none; margin-bottom:10px;"></h4>
            <h4>Tareas Pendientes (Priorizadas)</h4><div id="pendingList" class="task-grid"></div>
            <h4 style="margin-top:30px; color:var(--verde)">Historial de Ã‰xito</h4><div id="completedList" class="task-grid"></div>
        </div>
    </section>
  </main>
</div>

<div id="admin-dash" class="hidden">
  <header style="background:#333"><strong>PANEL ADMIN 2CM2</strong><button onclick="location.reload()" class="btn-prog">Cerrar</button></header>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; padding:20px;">
    <div class="card-custom"><h3>Impacto: Pre vs Post Prueba</h3><canvas id="compareChart"></canvas></div>
    <div class="card-custom"><h3>Trazabilidad Digital</h3><div id="logsBox" class="log-monitor"></div><button onclick="exportPDF()" class="btn-prog" style="margin-top:10px; background:var(--azul)">Exportar PDF</button></div>
  </div>
</div>

<script>
  // PREGUNTAS RESTAURADAS
  const preQs = ["Â¿Capacidad para cumplir plazos sin estrÃ©s?", "Â¿Nivel de sobrecarga cognitiva?", "Â¿Eficiencia percibida herramientas actuales?", "Â¿Sentido control Mapa 2020?", "Â¿Necesidad recordatorios?", "Â¿Frecuencia olvido fechas?", "Â¿EstrÃ©s por desorganizaciÃ³n?", "Â¿Calidad autogestiÃ³n actual?", "Â¿Facilidad priorizar tareas?", "Â¿Confianza Ã©xito acadÃ©mico?"];
  const postQs = ["Â¿Capacidad plazos mejorÃ³?", "Â¿Prototipo redujo sobrecarga?", "Â¿Eficiencia del prototipo?", "Â¿Control real Mapa 2020?", "Â¿Recordatorios Ãºtiles?", "Â¿ReducciÃ³n olvido fechas?", "Â¿DisminuyÃ³ estrÃ©s acadÃ©mico?", "Â¿Calidad autogestiÃ³n sistema?", "Â¿FÃ¡cil priorizar con app?", "Â¿Confianza Ã©xito con app?"];

  // LISTA DE ALUMNOS (26 SUJETOS)
  const alumnosDB = [
    { u: "2026630001", p: "escom2026", n: "Pamela Torres Martinez", av: 45 },
    { u: "2026630002", p: "escom2026", n: "Mariana Fernanda Cisneros Aleman", av: 47 },
    { u: "2026630003", p: "escom2026", n: "Ivanna Ayelen Zuniga Alcantara", av: 38 },
    { u: "2026630004", p: "escom2026", n: "Jorge Ernesto Villalpando Lopez", av: 44 },
    { u: "2026630005", p: "escom2026", n: "Abigail Antonio Francisco", av: 43 },
    { u: "2026630006", p: "escom2026", n: "Javier Emiliano Elizondo Escudero", av: 35 },
    { u: "2026630007", p: "escom2026", n: "Christopher Emmanuel Aguilera Garcia", av: 42 },
    { u: "2026630008", p: "escom2026", n: "Ethan Eliud Ramirez Barajas", av: 46 }, // Demo limpio
    { u: "2026630009", p: "escom2026", n: "Ismael Alvarado Olasagasti", av: 48 },
    { u: "2026630010", p: "escom2026", n: "Esmeralda Arizbeth Chagoya Martinez", av: 48 },
    { u: "2026630011", p: "escom2026", n: "Diego Campos JuÃ¡rez", av: 36 },
    { u: "2026630012", p: "escom2026", n: "Daniel Alejandro Patino Farias", av: 41 },
    { u: "2026630013", p: "escom2026", n: "Jorge Abraham Perez Lazcano", av: 34 },
    { u: "2026630014", p: "escom2026", n: "Israel Mendez Trejo", av: 40 },
    { u: "2026630015", p: "escom2026", n: "Gustavo Emiliano Acosta Rojano", av: 44 },
    { u: "2026630016", p: "escom2026", n: "Emanuel Morales Gonzalez", av: 41 },
    { u: "2026630017", p: "escom2026", n: "Osmar Damian Garcia Rodriguez", av: 35 },
    { u: "2026630018", p: "escom2026", n: "Jaime Raul Vargas Melendez", av: 37 },
    { u: "2026630019", p: "escom2026", n: "Nayeli Manuel Sanchez", av: 42 },
    { u: "2026630020", p: "escom2026", n: "Luis Fernando Quiroga Esquivel", av: 40 },
    { u: "2026630021", p: "escom2026", n: "Ithan Said Soto Estrada", av: 33 },
    { u: "2026630022", p: "escom2026", n: "Rogelio Caballero Paz", av: 40 },
    { u: "2026630023", p: "escom2026", n: "Valeria Diaquiz Palomeque", av: 50 },
    { u: "2026630024", p: "escom2026", n: "Jorge Asael Mendoza Martinez", av: 31 },
    { u: "2026630025", p: "escom2026", n: "Oswaldo Corona Rojas", av: 44 },
    { u: "2026630026", p: "escom2026", n: "FÃ©lix AarÃ³n Ocampo Ramos", av: 37 }
  ];

  const materiasMap = [
    {id:1, s:1, n:"CÃ¡lculo", c:7.5}, {id:2, s:1, n:"Vectorial", c:7.5}, {id:3, s:1, n:"Discretas", c:10.5},
    {id:4, s:1, n:"ComunicaciÃ³n", c:7.5}, {id:5, s:1, n:"ProgramaciÃ³n", c:7.5},
    {id:6, s:2, n:"Ãlgebra", c:9.0}, {id:7, s:2, n:"CÃ¡lculo Ap.", c:7.5}, {id:8, s:2, n:"MecÃ¡nica", c:10.5},
    {id:9, s:2, n:"Ã‰tica", c:9.0}, {id:10, s:2, n:"EconÃ³micos", c:7.5}, {id:11, s:2, n:"Estructuras", c:7.5},
    {id:99, s:3, n:"Sem. 3-8 (Bloqueado)", c:0, locked:true}
  ];

  let tasks = JSON.parse(localStorage.getItem('tasks_v15')) || [];
  let logs = JSON.parse(localStorage.getItem('logs_v15')) || [];
  let preD = JSON.parse(localStorage.getItem('pre_v15')) || [];
  let postD = JSON.parse(localStorage.getItem('post_v15')) || [];
  let currentS = null;
  let approvedIds = [];
  let pomoInt;
  let secRem = 1500;

  // GENERAR HISTORIAL SEGÃšN POBLACIÃ“N ISC 2020
  if(tasks.length === 0) {
    const sem1 = ["MatemÃ¡ticas Discretas", "AnÃ¡lisis Vectorial", "CÃ¡lculo"];
    const sem2 = ["CÃ¡lculo Aplicado", "IngenierÃ­a, Ã‰tica y Sociedad", "Algoritmos y Estructuras de Datos"];
    
    alumnosDB.forEach((a, i) => {
      if(i === 7) return; // Ethan Eliud limpio
      let pool = [...sem2];
      if(i < 6) pool.push(...sem1); else if(i < 15) pool.push("AnÃ¡lisis Vectorial", "CÃ¡lculo"); else pool.push("CÃ¡lculo");
      
      for(let j=1; j<=6; j++) tasks.push({id:Math.random(), u:a.u, n:`${pool[Math.floor(Math.random()*pool.length)]}: PrÃ¡ctica ${j}`, d:'2025-11-15', urg:1, done:true});
      for(let j=1; j<=5; j++) tasks.push({id:Math.random(), u:a.u, n:`${pool[Math.floor(Math.random()*pool.length)]}: Pendiente ${j}`, d:'2026-03-20', urg:Math.floor(Math.random()*3)+1, done:false});
      preD.push({u:a.u, ans: Array.from({length:10}, () => 1+Math.floor(Math.random()*3))});
      postD.push({u:a.u, ans: Array.from({length:10}, () => 4+Math.floor(Math.random()*2))});
    });
    localStorage.setItem('tasks_v15', JSON.stringify(tasks));
    localStorage.setItem('pre_v15', JSON.stringify(preD));
    localStorage.setItem('post_v15', JSON.stringify(postD));
  }

  function handleLogin() {
    const u = document.getElementById('userInput').value;
    const p = document.getElementById('passInput').value;
    if(u==="administrador" && p==="admin2026"){ 
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-dash').classList.remove('hidden'); loadAdmin(); return;
    }
    const s = alumnosDB.find(x => x.u === u && x.p === p);
    if(s) {
        currentS = s;
        approvedIds = JSON.parse(localStorage.getItem(`map_${s.u}`)) || [];
        document.getElementById('login-screen').classList.add('hidden');
        renderS('pre-qs', preQs, 'pre-ans'); renderS('post-qs', postQs, 'post-ans');
        document.getElementById('survey-screen').classList.remove('hidden');
        addLog(`Inicio: ${s.u}`);
    }
  }

  function openMap() {
    const g = document.getElementById('mapGrid'); g.innerHTML = "";
    let curSem = 0;
    materiasMap.forEach(m => {
        if(m.s !== curSem) { curSem = m.s; g.innerHTML += `<div class="sem-header">Semestre ${curSem}</div>`; }
        const isP = approvedIds.includes(m.id);
        g.innerHTML += `<div class="subject-box ${m.locked?'locked':''} ${isP?'passed':''}" onclick="${m.locked?'':`toggleSub(${m.id})`}"><span>${m.n}</span><small>${m.c}cr</small></div>`;
    });
    document.getElementById('map-modal').classList.remove('hidden');
  }

  function toggleSub(id) {
    approvedIds = approvedIds.includes(id) ? approvedIds.filter(x=>x!==id) : [...approvedIds, id];
    localStorage.setItem(`map_${currentS.u}`, JSON.stringify(approvedIds));
    openMap(); updateDash();
  }

  function updateDash() {
    const totalC = materiasMap.filter(m=>!m.locked).reduce((a,c)=>a+c.c, 0);
    const appC = materiasMap.filter(m=>approvedIds.includes(m.id)).reduce((a,c)=>a+c.c, 0);
    const av = Math.round((appC/totalC)*100);
    document.getElementById('pBar').style.width = av+"%"; document.getElementById('pBar').textContent = av+"%";
    document.getElementById('creditosInfo').textContent = `CrÃ©ditos: ${appC.toFixed(1)} / ${totalC.toFixed(1)}`;
  }

  function renderS(id, l, cl) { document.getElementById(id).innerHTML = l.map((q,i)=>`<div style="margin-bottom:8px"><b>${q}</b><br><input type="range" min="1" max="5" class="${cl}" style="width:100%"></div>`).join(''); }

  function saveSurvey(t) {
    const ans = Array.from(document.querySelectorAll(t==='pre'?'.pre-ans':'.post-ans')).map(x=>parseInt(x.value));
    if(t==='pre') { 
        preD.push({u:currentS.u, ans}); document.getElementById('survey-screen').classList.add('hidden'); 
        document.getElementById('student-dash').classList.remove('hidden'); document.getElementById('studName').textContent=currentS.n; 
        updateDash(); renderTasks(); notify();
    } else { postD.push({u:currentS.u, ans}); alert("Impacto final registrado."); document.getElementById('post-survey-screen').classList.add('hidden'); }
    localStorage.setItem(t==='pre'?'pre_v15':'post_v15', JSON.stringify(t==='pre'?preD:postD));
    addLog(`Fase ${t} fin.`);
  }

  function addTask() {
    const n = document.getElementById('tIn').value, d = document.getElementById('tDate').value, u = document.getElementById('tUrg').value;
    if(!n || !d) return;
    if(confirm(`Â¿Programar "${n}"?`)) { tasks.push({id:Date.now(), u:currentS.u, n, d, urg:parseInt(u), done:false}); saveLS(); renderTasks(); document.getElementById('tIn').value=""; }
  }

  function renderTasks() {
    const p = document.getElementById('pendingList'), c = document.getElementById('completedList');
    p.innerHTML = ""; c.innerHTML = "";
    const filtered = tasks.filter(t => t.u === currentS.u).sort((a,b) => b.urg - a.urg || new Date(a.d) - new Date(b.d));
    filtered.forEach(t => {
        const html = `<div class="task-box urg-${t.urg} ${t.done?'done':''}"><div><b>${t.n}</b><br><small>${t.d} | U:${t.urg}</small></div>
            <div class="btn-action-group">
                ${!t.done ? `<button onclick="doneT(${t.id})" class="btn-small" style="background:var(--verde)">âœ“</button>` : ''}
                <button onclick="editT(${t.id})" class="btn-small" style="background:var(--azul)">âœŽ</button>
                <button onclick="delT(${t.id})" class="btn-small" style="background:var(--rojo)">ðŸ—‘</button>
            </div></div>`;
        if(t.done) c.innerHTML += html; else p.innerHTML += html;
    });
  }

  function doneT(id) { if(confirm("Â¿Completada?")) { tasks.find(x => x.id === id).done = true; saveLS(); renderTasks(); addLog("Tarea fin."); } }
  function delT(id) { if(confirm("Â¿Eliminar?")) { tasks = tasks.filter(x => x.id !== id); saveLS(); renderTasks(); addLog("Tarea delete."); } }
  function editT(id) { const t = tasks.find(x => x.id === id); const n = prompt("Nuevo nombre:", t.n); if(n){ t.n=n; saveLS(); renderTasks(); } }

  function notify() {
    const cr = tasks.filter(t => t.u === currentS.u && !t.done && t.urg === 3).length;
    if(cr > 0) { const n = document.getElementById('notif-text'); n.style.display='block'; n.innerHTML = `âš ï¸ Alerta: Tienes ${cr} tareas de Urgencia Alta.`; }
  }

  function startPomo(m) {
    clearInterval(pomoInt); secRem = m * 60;
    pomoInt = setInterval(() => { secRem--; updateUI(); if(secRem<=0){ clearInterval(pomoInt); alert("Ciclo terminado"); } }, 1000);
  }
  function pausePomo() { clearInterval(pomoInt); }
  function resetPomo() { clearInterval(pomoInt); secRem=1500; updateUI(); }
  function updateUI() { const min = Math.floor(secRem/60), sec = secRem%60; document.getElementById('pTime').textContent = `${min}:${sec < 10 ? '0' : ''}${sec}`; }
  function saveLS() { localStorage.setItem('tasks_v15', JSON.stringify(tasks)); }
  function addLog(m) { logs.push(`[${new Date().toLocaleTimeString()}] ${m}`); localStorage.setItem('logs_v15', JSON.stringify(logs)); }

  function loadAdmin() {
    const getA = (d) => { if(!d.length) return Array(10).fill(0); let s = Array(10).fill(0); d.forEach(x => x.ans.forEach((v, i) => s[i] += v)); return s.map(v => v/d.length); };
    new Chart(document.getElementById('compareChart'), {
        type: 'bar',
        data: {
            labels: ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8', 'Q9', 'Q10'],
            datasets: [{ label: 'Pre', data: getA(preD), backgroundColor: 'maroon' }, { label: 'Post', data: getA(postD), backgroundColor: 'blue' }]
        },
        options: { scales: { y: { beginAtZero: true, max: 5 } } }
    });
    document.getElementById('logsBox').innerHTML = logs.slice().reverse().map(l => `<div>> ${l}</div>`).join('');
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF(); doc.text("Trazabilidad 2CM2", 10, 10);
    logs.slice(-30).forEach((l, i) => doc.text(l, 10, 20 + (i*7)));
    doc.save("Reporte_Investigacion.pdf");
  }
</script>
</body>
</html>
