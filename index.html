<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gestión Académica - ESCOM</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --vino: #6d1d38; --azul: #008fcc; --verde: #28a745; --rojo: #dc3545; --negro: #1a1a1a; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: url("fondo.jpg") center/cover fixed; color: #333; }
    
    /* Pantallas de acceso */
    #login-screen, #survey-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: rgba(0,0,0,0.85); position: fixed; width: 100%; z-index: 2000; }
    .card-ui { background: white; padding: 30px; border-radius: 20px; width: 500px; text-align: center; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

    /* Layout */
    header { background: var(--vino); color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
    main { display: grid; grid-template-columns: 320px 1fr; gap: 20px; max-width: 1300px; margin: 20px auto; padding: 0 20px; }
    .card-custom { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    /* Tareas (Estilo Imagen) */
    .task-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .task-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .task-box { background: white; padding: 15px; border-radius: 12px; border-left: 8px solid var(--azul); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .status-tag { font-weight: bold; font-size: 0.85em; }
    .vence-hoy { color: var(--rojo); }
    .vence-ok { color: var(--verde); }

    /* Admin */
    .log-monitor { background: #000; color: #00ff00; font-family: monospace; padding: 15px; height: 300px; overflow-y: auto; border-radius: 10px; text-align: left; font-size: 0.8em; }
    
    .hidden { display: none !important; }
    input, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .btn-prog { background: var(--vino); color: white; border: none; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

<div id="login-screen">
  <div class="card-ui" style="width:350px">
    <img src="mascota_escom.jpg" width="70">
    <h2 style="color:var(--vino)">Investigación 2CM2</h2>
    <input type="text" id="userInput" placeholder="Boleta / Administrador" style="width:90%; margin-bottom:10px;">
    <input type="password" id="passInput" placeholder="Contraseña" style="width:90%">
    <button onclick="handleLogin()" class="btn-prog" style="width:95%; margin-top:15px">INGRESAR</button>
    <p id="error-msg" style="color:red; font-size:0.8em"></p>
  </div>
</div>

<div id="survey-screen" class="hidden">
  <div class="card-ui">
    <h3 style="color:var(--vino)">Encuesta de Productividad Inicial</h3>
    <div id="survey-questions" style="text-align:left; font-size:0.9em">
      <div style="margin-bottom:15px">1. ¿Capacidad para cumplir plazos sin estrés?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">2. ¿Nivel de sobrecarga cognitiva por dispersión de plataformas?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">3. ¿Eficiencia percibida de tus herramientas actuales?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">4. ¿Sentido de control sobre el Mapa Curricular 2020?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">5. ¿Necesidad percibida de recordatorios inteligentes?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">6. ¿Frecuencia de olvido de fechas críticas?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">7. ¿Nivel de estrés académico por desorganización?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">8. ¿Calidad de tu autogestión actual?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">9. ¿Facilidad para priorizar tareas diarias?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
      <div style="margin-bottom:15px">10. ¿Confianza en el éxito académico con automatización?<br><input type="range" min="1" max="5" class="s-ans" style="width:100%"></div>
    </div>
    <button onclick="saveSurveyAndGo()" class="btn-prog" style="width:100%; margin-top:10px">Finalizar y Entrar</button>
  </div>
</div>

<div id="student-dash" class="hidden">
  <header>
    <div><strong>Alumno: <span id="studName"></span></strong></div>
    <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; padding:5px">Salir</button>
  </header>
  <main>
    <aside>
        <div class="card-custom">
            <h4>Avance Curricular</h4>
            <div style="background:#ddd; border-radius:10px; height:20px;"><div id="pBar" style="background:var(--azul); height:100%; width:0%; transition:1s"></div></div>
        </div>
        <div class="card-custom" style="background:var(--negro); color:white; text-align:center">
            <h4>Pomodoro</h4>
            <div style="font-size:2em">25:00</div>
            <button class="btn-prog" style="background:white; color:var(--negro)">Iniciar</button>
        </div>
    </aside>
    <section>
        <div class="card-custom">
            <h3>Gestor de Tareas y Plazos</h3>
            <div class="task-input-group">
                <input type="text" id="tIn" placeholder="Nueva tarea..." style="flex:2">
                <input type="date" id="tDate">
                <button onclick="addTask()" class="btn-prog">Programar</button>
            </div>

            <h4>Tareas Pendientes</h4>
            <div id="pendingList" class="task-grid"></div>

            <h4 style="margin-top:30px; color:var(--verde)">Tareas Completadas</h4>
            <div id="completedList" class="task-grid"></div>
        </div>
    </section>
  </main>
</div>

<div id="admin-dash" class="hidden">
  <header style="background:#333">
    <div><strong>PANEL DE CONTROL ADMINISTRATIVO</strong></div>
    <button onclick="location.reload()" class="btn-prog">Cerrar Sesión</button>
  </header>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; padding:20px;">
    <div class="card-custom">
        <h3>Perfil Grupal 2CM2</h3>
        <canvas id="adminChart"></canvas>
    </div>
    <div class="card-custom">
        <h3>Logs de Actividad</h3>
        <div id="logsBox" class="log-monitor"></div>
        <button onclick="exportPDF()" class="btn-prog" style="width:100%; margin-top:10px; background:var(--azul)">Exportar PDF</button>
    </div>
  </div>
</div>

<script>
  const ADMIN_ACC = { u: "administrador", p: "admin2026" };
  const alumnosDB = [
    { u: "2026630001", p: "escom2026", n: "Pamela Torres Martinez", av: 45 },
    { u: "2026630009", p: "escom2026", n: "Esmeralda Arizbeth Chagoya Martinez", av: 48 },
    { u: "2026630037", p: "escom2026", n: "Lilian Martinez Acosta", av: 55 }
  ];

  let currentStudent = null;
  let logs = JSON.parse(localStorage.getItem('logs_final')) || [];
  let surveys = JSON.parse(localStorage.getItem('surveys_final')) || [];
  let tasks = JSON.parse(localStorage.getItem('tasks_final')) || [];

  function handleLogin() {
    const u = document.getElementById('userInput').value;
    const p = document.getElementById('passInput').value;
    if(u === ADMIN_ACC.u && p === ADMIN_ACC.p) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-dash').classList.remove('hidden');
        loadAdmin();
    } else {
        const s = alumnosDB.find(a => a.u === u && a.p === p);
        if(s) {
            currentStudent = s;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('survey-screen').classList.remove('hidden');
            addLog(`Sujeto ingresó: ${s.u}`);
        } else { document.getElementById('error-msg').textContent = "Error de acceso"; }
    }
  }

  function saveSurveyAndGo() {
    const ans = Array.from(document.querySelectorAll('.s-ans')).map(i => i.value);
    surveys.push({ boleta: currentStudent.u, data: ans });
    localStorage.setItem('surveys_final', JSON.stringify(surveys));
    
    document.getElementById('survey-screen').classList.add('hidden');
    document.getElementById('student-dash').classList.remove('hidden');
    document.getElementById('studName').textContent = currentStudent.n;
    document.getElementById('pBar').style.width = currentStudent.av + "%";
    renderTasks();
    addLog(`Encuesta completada por ${currentStudent.u}`);
  }

  function addTask() {
    const name = document.getElementById('tIn').value;
    const date = document.getElementById('tDate').value;
    if(!name || !date) return alert("Completa los datos");
    
    if(confirm(`¿Deseas programar la tarea: ${name}?`)) {
        tasks.push({ id: Date.now(), user: currentStudent.u, name, date, done: false });
        localStorage.setItem('tasks_final', JSON.stringify(tasks));
        renderTasks();
        addLog(`Tarea creada: ${name}`);
        document.getElementById('tIn').value = "";
    }
  }

  function renderTasks() {
    const pend = document.getElementById('pendingList');
    const comp = document.getElementById('completedList');
    pend.innerHTML = ""; comp.innerHTML = "";

    tasks.filter(t => t.user === currentStudent.u).forEach(t => {
        const diff = Math.ceil((new Date(t.date) - new Date()) / (1000*60*60*24)) + 1;
        let statusTxt = diff < 0 ? "Vencida" : diff === 0 ? "¡Hoy vence!" : `Faltan ${diff} días`;
        let sClass = diff <= 0 ? "vence-hoy" : "vence-ok";

        const html = `
            <div class="task-box">
                <div>
                    <b>${t.name}</b><br><small>${t.date}</small><br>
                    <span class="status-tag ${sClass}">${t.done ? 'Completada' : statusTxt}</span>
                </div>
                <div>
                    ${!t.done ? `<button onclick="completeTask(${t.id})" style="background:var(--verde); color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer">Concluir</button>` : ''}
                    <button onclick="deleteTask(${t.id})" style="background:none; border:none; color:#ccc; cursor:pointer; font-size:1.2em">×</button>
                </div>
            </div>`;
        if(t.done) comp.innerHTML += html; else pend.innerHTML += html;
    });
  }

  function completeTask(id) {
    const t = tasks.find(x => x.id === id);
    t.done = true;
    localStorage.setItem('tasks_final', JSON.stringify(tasks));
    renderTasks();
    addLog(`Tarea concluida: ${t.name}`);
  }

  function deleteTask(id) {
    if(confirm("¿Seguro que quieres eliminar esta tarea?")) {
        tasks = tasks.filter(t => t.id !== id);
        localStorage.setItem('tasks_final', JSON.stringify(tasks));
        renderTasks();
        addLog(`Tarea eliminada ID: ${id}`);
    }
  }

  function addLog(msg) {
    logs.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
    localStorage.setItem('logs_final', JSON.stringify(logs));
  }

  function loadAdmin() {
    document.getElementById('logsBox').innerHTML = logs.slice().reverse().map(l => `<div>> ${l}</div>`).join('');
    new Chart(document.getElementById('adminChart'), {
        type: 'radar',
        data: {
            labels: ['Plazos', 'Carga', 'Eficiencia', 'Mapa', 'Alertas', 'Olvido', 'Estrés', 'Gestión', 'Prioridad', 'Confianza'],
            datasets: [{ label: 'Promedio 2CM2', data: [3, 2, 4, 3, 4, 2, 4, 3, 3, 4], backgroundColor: 'rgba(109,29,56,0.5)', borderColor: '#6d1d38' }]
        }
    });
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Evidencia de Trazabilidad - 2CM2", 10, 10);
    logs.forEach((l, i) => doc.text(l, 10, 20 + (i*7)));
    doc.save("Evidencia_Final.pdf");
  }
</script>
</body>
</html>
